<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HTML</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
    body {
        padding: 30px;
    }
    
    .dropdown>.dropdown-menu {
        position: absolute;
        margin-bottom: 5px;
        top: 34px;
    }
    
    .dropdown:after {
        clear: left;
    }
    
    .dropdown.show>.dropdown-menu{
        display: block;
    }
    /* .dropdown>.dropdown-toggle {
          float: left;
      }*/
    
    table {
        font-family: verdana, arial, sans-serif;
        font-size: 11px;
        color: #333333;
        border-width: 1px;
        border-color: #a9c6c9;
        border-collapse: collapse;
    }
    
    table th {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #a9c6c9;
    }
    
    table td {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #a9c6c9;
    }
    
    table tr:nth-child(odd) td {
        background-color: #d4e3e5;
    }
    
    table tr:nth-child(even) td {
        background-color: #c3dde0;
    }
    </style></head>

<body>
    <div id="btn-contain" style="">
        <div class="dropdown createBtn">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" style="min-width:100px;">
                <span class="dropdown-text">create</span>
                <span class="caret"></span>
            </button>
            <!-- <ul class="dropdown-menu" style="display:none;">
                <li><a href="javascript:void 0;" value="Table">Table</a></li>
                <li><a href="javascript:void 0;" value="Button">Button</a></li>
                <li><a href="javascript:void 0;" value="Text">Input Text</a></li>
                <li><a href="javascript:void 0;" value="DIV">DIV</a></li>
            </ul> -->
        </div>
      <!--   <button id="btn-create" class="btn btn-default" type="button" id="dropdownMenu2" style="margin-left:15px;">
            create
        </button> -->
    </div>
    <div id="content" style="margin-top:20px;">
    </div>
    <div class="dropdown">
        <ul class="dropdown-menu">
            <li><a href="#" value="0">Delete</a></li>
            <li><a href="#" value="1">Background Color</a></li>
            <li><a href="#" value="2">Font size(+)</a></li>
            <li><a href="#" value="3">Font size(-)</a></li>
        </ul>
    </div> 
    <script type="text/template" id="tpl-createBtn">
            <ul id="btnListView" class="dropdown-menu" aria-labelledby="dropdownMenu">
                <%_.each(obj,function(e,i){%>
                    <li>
                        <a href="javascript:void 0;" class="dropdown-menu-<%= e.id%>" value="<%= e.id%>">
                            <%= e.text%>
                        </a>
                    </li>
                    <%})%>
            </ul>
        </script>
    <script type="text/template" id="tpl-popup">
            <ul id="popupListView" class="dropdown-menu" aria-labelledby="dropdownMenu">
                <%_.each(obj,function(e,i){%>
                    <li>
                        <a href="javascript:void 0;" class="dropdown-menu-<%= e.id%>">
                            <%= e.text%>
                        </a>
                    </li>
                    <%})%>
            </ul>
        </script>
</body>
    <script src="js/jquery.min.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/backbone.js"></script>
    <script src="js/backbone.localStorage.js"></script>
    <script type="text/javascript">


'use strict';
var domain = 'http://admadevwb8001:8001/api/html/elements';
//var domain = 'http://localhost:3000/api/html/elements';

var dataAPI = {
    'createBtn': '',
    'btnAction': {
        'button': '/button/actions',
        'inputText': '/inputText/actions',
        'table': '/table/actions',
        'div': '/div/actions',
        'image': '/image/actions',
    },
    'data': {
        'button': '/button/data',
        'inputText': '/inputText/data',
        'table': '/table/data',
        'div': '/div/data',
        'image': '/image/data',
    }
}

function Dropdown(option) {
    this.option = $.extend(option||{},{
        ele: '.createBtn.dropdown', //contains
        list: null,
    });
    this.dropdown = $(this.option.ele);
    var self = this;
    this.data = $.ajax({
            type: 'get',
            url: domain
        }).done(function(res) {
            console.log(res);
            self.dropdown.append(self.option.template(res.data));
            self.dropdownMeu = self.dropdown.find('.dropdown-menu li a');
            self.initialize();
        }).fail(function(err) {
            console.info(err);
        });
    this.val = 'Table';
    this.dropdownText = this.dropdown.find('.dropdown-text');
}
Dropdown.prototype = {
    constructor: Dropdown,
    initialize: function() {
        var self = this;
        this.dropdownMeu.on('click', function(e) {
            self.val = $(this).attr('value');
            console.log($(this).attr('value'))
            self.dropdownText.text(self.val);
            $('.dropdown-toggle').next().toggle();
            var evt = window.event || e;
            evt.stopPropagation&&e.stopPropagation();
            evt.cancelBubble = true;
            new Template({
                type: self.val,
                container: '#content'
            });
        });
        this.toggle();
    },
    toggle: function() {
        $('.dropdown-toggle').on('click', function(e) {
            $('.dropdown-toggle').next().toggle();
            var evt = window.event || e;
            evt.stopPropagation&&evt.stopPropagation();
            evt.cancelBubble = true;
        });
    },
}

function Template(option) { //根据模板创建element
    this.option = option || {};
    this.defalutTemplate = {
        'table':'createTableTemplate',
        'div':'createDivTemplate',
        'button':'createButtonTemplate',
        'inputText':'createInputTemplate',
        'image':'createImageTemplate',
    };
    this.initialize();
}

Template.prototype = {
    constructor: Template,
    initialize: function() {
        this.bindEvents();
        console.log(this.defalutTemplate[this.option.type]);
        var self = this;
        $.ajax({
            type: 'get',
            url: domain+dataAPI.data[this.option.type],
        }).done(function(res) {
            console.log(res);
            var dom = self[self.defalutTemplate[self.option.type]](res);
            $(self.option.container).append(dom);
        }).fail(function(err) {
            console.info(err);
        });

        return this;
    },
    addBorder: function() {
        if (this[0].parentNode.className !== 'box-selected') {
            var div = document.createElement('div');
            div.className = 'box-selected';
            this.wrap(div);
        }
    },
    bindEvents: function() {
        var self = this;
        $(self.option.container).delegate('click', '.template', function(e) {
            if (!this.data('template')) {
                this.data('template', self);
            }
            $('.template').unwrap('.box-selected');
            self.addBorder.call(this);
            self.option.popup.setTemplate(this);
            self.option.popup.showPopUp.call(this, e);
        });

    },
    createTableTemplate: (function() {
        var instance;
        function Table(data) {
            this.rowCount = 0;
            this.cellCount = 0;
            this.data = data; //只取一次
            this.init(data);
        }
        Table.prototype = {
            constructor: Table,
            init: function(res) {
                this.rowCount = res.data.rows;
                this.cellCount = res.data.cols;
                this.cellData = res.data.cells;

                var sortResult = this.sort();
                this.newTableTemplate()
            },
            sort: function() {
                this.sortResult = this.cellData.sort(function(td0, td1) {
                    if (td0.row === td1.row) {
                        return td0.col - td1.col;
                    } else {
                        return td0.row - td1.row;
                    }
                });
            },
            newTableTemplate: function() {
                var sortResult = this.sortResult;
                var oFragmeng = document.createDocumentFragment();
                var table = document.createElement('table');
                for (var i = 0; i < this.rowCount; i++) {
                    var tr = document.createElement('tr');
                    for (var j = 0; j < this.cellCount; j++) {
                        var td = document.createElement('td');
                        if (sortResult[i * this.rowCount + j]) {
                            var     oText = document.createTextNode(sortResult[i * this.rowCount + j].data);
                        } else {
                            var     oText = document.createTextNode('');
                        }
                        td.appendChild(oText);
                        tr.appendChild(td);
                    }
                    oFragmeng.appendChild(tr);
                }
                table.appendChild(oFragmeng)
                this.table = table;
            }
        };
        return function(data) {
            var self = this;
            if (instance && instance.table) {
                return instance.table;
            } else {
                var table = new Table(data).table;
                return table;
            }
        }
        })(),
        createDivTemplate:function(res){
            return $(res.data.text);
        },
        createButtonTemplate:function(res){
            return $('<button>').attr({
                title:res.data.title,
            }).text(res.data.text);
        },
        createInputTemplate:function(res){
            var input = document.createElement('input');
            input.setAttribute('placeholder',res.data.text)
            return input;
        },
        createImageTemplate:function(res){
            return $('<img>').attr({
                src:res.data.image,
                title:res.data.title,
            });
        },
}


function Popup() {
    this.curTemplate = null;
    this.fontSize = '11px';
    this.initialize()
}

Popup.prototype = {
    constructor: Popup,
    initialize: function() {
        this.bindEvents();
    },
    bindEvents: function() {
        var self = this
        $('.popUp').delegate('click', 'a', function() {
            var val = this[0].getAttribute('value');
            var curTemplate = self.getTemplate();
            if (val === '0') {
                curTemplate.parent('.box-selected')
                    .remove();
            } else if (val === '1') {
                self.changeBgColor();
                $('.box-selected').before(curTemplate[0]);
                self.removeBorder();
            } else if (val === '2') {
                self.changeFontSize('add');
            }else if(val === '3'){
                self.changeFontSize('cut');
            }
            self.hidePopUp();
        });
        $(document).on('click',function(){
            self.hidePopUp();
        })
    },
    showPopUp: function(e) {
        var scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
        $('.popUp').show()
            .css({
                top: e.clientY +
                    scrollTop + 'px',
                left: e.clientX + 'px'
            });
    },
    hidePopUp: function() {
        $('.popUp').hide();
    }, 
    removeBorder: function() {
        $('.box-selected').remove();
    },
    setTemplate: function(dom) {
        this.curTemplate = dom;
    },
    getTemplate: function() {
        return this.curTemplate;
    },
    changeBgColor: function() {
        this.curTemplate.css('background', $.makeColor());
    },
    changeFontSize: function(type) {
        var curfontSize = parseInt(this.curTemplate.css('fontSize'));
        if(type=='add'){
            this.fontSize = (curfontSize+1)+'px';
            this.curTemplate.css('fontSize',this.fontSize);
        }else{
            this.fontSize  = (curfontSize-1)+'px';
            this.curTemplate.css('fontSize',this.fontSize);
        }
    }
}

$(function() {
    var popup = new Popup({
        template:_.template($('#tpl-popup').html()),
    });
    var combo = new Dropdown({
        template:_.template($('#tpl-createBtn').html()),
    });
    $(document).on('click', function() {
        //$('.dropdown-toggle').next().hide();
    });
})


</script>

</html>
